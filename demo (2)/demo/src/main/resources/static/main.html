<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>MediMap - Main</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/main.css" />
</head>
<body>

<a href="/index.html" class="global-brand-title">MediMap</a>
<button class="logout-button" onclick="logout()">Logout</button>

<div class="top-bar">
    <div class="top-inner">
        <button class="btn" id="recommend-btn">Recommend</button>
        <input type="text" id="searchInput" class="search-input" placeholder="Search drug..." />
        <button class="btn" id="searchBtn">Search</button>
        <button class="btn" id="member-info-btn">Member Info</button>
    </div>
</div>

<div class="user-role-text">Current User: Customer</div>

<!-- ë§ˆì»¤ ë²”ë¡€ -->
<div id="legend">
    <div class="legend-item">
        <img src="/images/locationMarker.png" alt="í˜„ì¬ ìœ„ì¹˜" />
        <span>í˜„ì¬ ìœ„ì¹˜</span>
    </div>
    <div class="legend-item">
        <img src="/images/pharmacyMarker.png" alt="ì•½êµ­ ìœ„ì¹˜" />
        <span>ì•½êµ­ ìœ„ì¹˜</span>
    </div>
</div>

<div id="map"></div>
<button id="gps-button">ë‚´ ìœ„ì¹˜ë¡œ ì´ë™</button>

<div id="drug-popup-container"></div>

<script>
    fetch("/components/drug-popup.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("drug-popup-container").innerHTML = html;
        const script = document.createElement("script");
        script.src = "/js/drug.js";
        script.onload = () => {
          console.log("âœ… drug.js ë¡œë“œë¨");
          setupDrugSearch();  // âœ… ì—¬ê¸°ì— ì§ì ‘ í˜¸ì¶œ!
        };
        document.body.appendChild(script);
      });
</script>

<!-- ğŸ”¹ ë™ì ìœ¼ë¡œ íŒì—… ì‚½ì… -->
<div id="popup-container"></div>

<!-- ì§€ë„ API -->
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=49b9e54253fed14ad19b574016b04efd&libraries=services"></script>
<!-- ë©”ì¸ ë¡œì§ -->
<script src="/js/main.js"></script>
<!-- íšŒì›ì •ë³´ íŒì—… ë¡œë”© -->
<script>
    fetch("/components/member-popup.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("popup-container").innerHTML = html;

        const script = document.createElement("script");
        script.src = "/js/member.js";
        script.onload = () => {
          // íŒì—… JS ë¡œë”© ì™„ë£Œ í›„ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
          document.getElementById("member-info-btn")?.addEventListener("click", openMemberPopup);

          // âœ… ì—¬ê¸°ì— ì§ì ‘ form ì´ë²¤íŠ¸ ì—°ê²°!
          const form = document.getElementById("member-form");
          const deleteBtn = document.getElementById("delete-user");

          if (form) {
            form.addEventListener("submit", async (e) => {
              e.preventDefault();
              console.log("âœ… form submitted");

              const email = form.email.value;
              const currentPassword = form.currentPassword.value;
              const newPassword = form.newPassword.value;

              if (!currentPassword) {
                alert("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
              }

              if (newPassword && !isValidPassword(newPassword)) {
                alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì/ì˜ë¬¸ í¬í•¨ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return;
              }

              try {
                const res = await fetch("/api/users/me", {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ email, currentPassword, newPassword })
                });

                const resultText = await res.text();
                console.log("ğŸ” ì‘ë‹µ ìƒíƒœ:", res.status);
                console.log("ğŸ“© ì‘ë‹µ ë³¸ë¬¸:", resultText);

                if (res.ok) {
                  alert("ë¹„ë°€ë²ˆí˜¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                  closeMemberPopup();
                } else if (res.status === 401) {
                  alert("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                } else {
                  alert("ìˆ˜ì • ì‹¤íŒ¨: " + resultText);
                }
              } catch (err) {
                console.error("âŒ fetch ì˜¤ë¥˜:", err);
                alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            });
          }

          if (deleteBtn) {
            deleteBtn.addEventListener("click", async () => {
              const email = form.email.value;
              if (!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

              try {
                const res = await fetch(`/api/users/me?email=${email}`, { method: "DELETE" });
                if (res.ok) {
                  alert("íƒˆí‡´ ì™„ë£Œ");
                  localStorage.clear();
                  window.location.href = "/login.html";
                } else {
                  alert("íƒˆí‡´ ì‹¤íŒ¨");
                }
              } catch (err) {
                console.error("âŒ íƒˆí‡´ ì˜¤ë¥˜:", err);
                alert("ì„œë²„ ì˜¤ë¥˜");
              }
            });
          }
        };

        document.body.appendChild(script);
      });
</script>
<!-- ì¦ìƒ ì¶”ì²œ íŒì—… ë¡œë”© -->
<script>
    fetch("/components/symptom-popup.html")
      .then(res => res.text())
      .then(html => {
        const container = document.createElement("div");
        container.innerHTML = html;
        document.body.appendChild(container);

        const script = document.createElement("script");
        script.src = "/js/recommend.js";
        script.onload = () => {
          document.getElementById("recommend-btn")?.addEventListener("click", openSymptomPopup);
        };
        document.body.appendChild(script);
      });
</script>

</body>
</html>